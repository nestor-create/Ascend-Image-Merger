<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ascend Image Merger</title>

<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
  header{padding:16px 24px;background:#fff;border-bottom:1px solid #e7e7e7;position:sticky;top:0;z-index:10}
  .header-container{display:flex;align-items:center;gap:14px}
  .logo{height:36px;width:auto;border-radius:8px}
  h1{margin:0;font-size:18px}
  .sub{margin-top:6px;font-size:13px;color:#555}

  .wrap{max-width:1100px;margin:16px auto;padding:0 16px 24px;display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media(max-width:980px){.wrap{grid-template-columns:1fr}}

  .card{background:#fff;border:1px solid #e7e7e7;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);overflow:hidden}
  .card h2{margin:0;font-size:14px;padding:12px;border-bottom:1px solid #eee;background:#fcfcfc}
  .content{padding:12px}

  .drop{border:2px dashed #cfcfcf;border-radius:12px;padding:14px;background:#fbfbfb;text-align:center;min-height:120px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center}
  .drop.dragover{border-color:#111;background:#f3f3f3}

  .btnrow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  button{border:1px solid #ddd;background:#fff;padding:9px 10px;border-radius:10px;cursor:pointer;font-weight:700;font-size:13px}
  button.primary{background:#111;color:#fff;border-color:#111}
  button:disabled{opacity:.5;cursor:not-allowed}

  label{display:block;font-size:12px;color:#444;margin-top:10px}
  input[type="number"], input[type="text"], select{
    width:100%;box-sizing:border-box;padding:9px 10px;border-radius:10px;border:1px solid #ddd;
    font-size:13px;margin-top:6px;background:#fff
  }

  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .toggleRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .toggle{display:flex;gap:8px;align-items:center;font-size:12px;color:#444}

  .list{display:flex;flex-direction:column;gap:8px;max-height:280px;overflow:auto;margin-top:8px}
  .item{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;border:1px solid #eee;border-radius:12px;padding:8px}
  .thumb{width:56px;height:56px;border-radius:10px;object-fit:cover;background:#f0f0f0;border:1px solid #eee}
  .meta{font-size:12px;color:#555}
  .meta b{display:block;color:#111;font-size:13px;margin-bottom:2px}
  .actions{display:flex;gap:6px}
  .actions button{padding:6px 8px;border-radius:10px;font-size:12px}

  .status{font-size:12px;color:#555}
  .note{font-size:12px;color:#666;margin-top:10px;line-height:1.35}
  .canvasWrap{margin-top:10px;border:1px solid #eee;border-radius:12px;overflow:auto;background:#fff;max-height:72vh}
  canvas{display:block;max-width:100%;height:auto}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;border:1px solid #ddd;border-bottom-width:2px;border-radius:8px;padding:2px 6px;background:#fff;font-size:12px}

  #exportCanvas{display:none}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="ascend-logo.png" alt="Ascend Logo" class="logo">
    <div>
      <h1>Ascend Image Merger</h1>
      <div class="sub">
        Auto-align content • retina preview • paste with <span class="kbd">Ctrl</span>+<span class="kbd">V</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2>Input</h2>
    <div class="content">
      <div id="drop" class="drop" tabindex="0">
        <strong>Paste or drop images here</strong>
        <small>Ctrl+V • or drag files • or Add Images</small>
        <div class="btnrow">
          <button id="addBtn" class="primary">Add Images</button>
          <button id="clearBtn" disabled>Clear</button>
        </div>
        <input id="fileInput" type="file" accept="image/*" multiple hidden>
      </div>

      <label>Images</label>
      <div id="list" class="list"></div>

      <div class="row">
        <div>
          <label>Gap (px)</label>
          <input id="gap" type="number" min="0" step="1" value="0">
        </div>
        <div>
          <label>Background</label>
          <input id="bg" type="text" value="#ffffff">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Alignment</label>
          <select id="align">
            <option value="left">Left (best for lines)</option>
            <option value="center">Center</option>
            <option value="right">Right</option>
          </select>
        </div>
        <div>
          <label>Trim tolerance (0–40)</label>
          <input id="trimTol" type="number" min="0" max="40" step="1" value="12">
        </div>
      </div>

      <div class="toggleRow">
        <label class="toggle">
          <input id="autoTrim" type="checkbox" checked>
          Auto align content (trim margins)
        </label>
        <label class="toggle">
          <input id="cap4k" type="checkbox" checked>
          Cap width at 4K (downscale only)
        </label>
        <label class="toggle">
          <input id="crispText" type="checkbox" checked>
          Crisp text (disable smoothing when possible)
        </label>
        <label class="toggle">
          <input id="retinaPreview" type="checkbox" checked>
          Retina preview
        </label>
      </div>

      <div class="btnrow" style="margin-top:12px;">
        <button id="mergeBtn" class="primary" disabled>Merge</button>
        <button id="copyBtn" disabled>Copy</button>
        <button id="openBtn" disabled>Open</button>
      </div>

      <div id="warn" class="note"></div>
      <div class="note">
        If images have extra white space/margins, enable <b>Auto align content</b> so all content lines up.
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Preview</h2>
    <div class="content">
      <div id="status" class="status">Add images to start.</div>
      <div class="canvasWrap">
        <canvas id="canvas"></canvas>
        <canvas id="exportCanvas"></canvas>
      </div>
    </div>
  </section>
</main>

<script>
  const MAX_4K = 3840;
  const SAFE_MP = 80;

  const drop=document.getElementById('drop');
  const fileInput=document.getElementById('fileInput');
  const addBtn=document.getElementById('addBtn');
  const clearBtn=document.getElementById('clearBtn');
  const listEl=document.getElementById('list');

  const gapEl=document.getElementById('gap');
  const bgEl=document.getElementById('bg');
  const alignEl=document.getElementById('align');
  const autoTrimEl=document.getElementById('autoTrim');
  const trimTolEl=document.getElementById('trimTol');

  const cap4kEl=document.getElementById('cap4k');
  const crispTextEl=document.getElementById('crispText');
  const retinaEl=document.getElementById('retinaPreview');

  const mergeBtn=document.getElementById('mergeBtn');
  const copyBtn=document.getElementById('copyBtn');
  const openBtn=document.getElementById('openBtn');

  const statusEl=document.getElementById('status');
  const warnEl=document.getElementById('warn');

  const canvas=document.getElementById('canvas');
  const exportCanvas=document.getElementById('exportCanvas');
  const pctx=canvas.getContext('2d');
  const ectx=exportCanvas.getContext('2d');

  let items=[];
  let lastBlobUrl=null;

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function safeParseColor(s){
    const t=document.createElement('canvas').getContext('2d');
    t.fillStyle='#ffffff';
    t.fillStyle=s;
    return t.fillStyle || '#ffffff';
  }

  function updateUI(){
    listEl.innerHTML='';
    items.forEach((it,idx)=>{
      const row=document.createElement('div');
      row.className='item';
      row.innerHTML=`
        <img src="${it.url}" class="thumb" alt="">
        <div class="meta"><b>${escapeHtml(it.name)}</b>${it.w} × ${it.h}px</div>
        <div class="actions">
          <button ${idx===0?'disabled':''} data-act="up">↑</button>
          <button ${idx===items.length-1?'disabled':''} data-act="down">↓</button>
          <button data-act="del">✕</button>
        </div>`;
      row.querySelector('[data-act="up"]')?.addEventListener('click',()=>move(idx,idx-1));
      row.querySelector('[data-act="down"]')?.addEventListener('click',()=>move(idx,idx+1));
      row.querySelector('[data-act="del"]')?.addEventListener('click',()=>removeAt(idx));
      listEl.appendChild(row);
    });

    clearBtn.disabled=!items.length;
    mergeBtn.disabled=items.length<2;
    statusEl.textContent=items.length?`${items.length} image(s) loaded.`:'Add images to start.';
  }

  function move(from,to){
    const a=items.splice(from,1)[0];
    items.splice(to,0,a);
    updateUI();
  }

  function removeAt(i){
    URL.revokeObjectURL(items[i].url);
    items.splice(i,1);
    updateUI();
  }

  function clearAll(){
    items.forEach(it=>URL.revokeObjectURL(it.url));
    items=[];
    if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
    lastBlobUrl=null;
    canvas.width=canvas.height=0;
    exportCanvas.width=exportCanvas.height=0;
    openBtn.disabled=true;
    copyBtn.disabled=true;
    warnEl.textContent='';
    updateUI();
  }

  function loadFile(file){
    return new Promise((resolve,reject)=>{
      const url=URL.createObjectURL(file);
      const img=new Image();
      img.onload=()=>resolve({name:file.name||'image',img,w:img.naturalWidth,h:img.naturalHeight,url});
      img.onerror=()=>{URL.revokeObjectURL(url);reject(new Error('load failed'))};
      img.src=url;
    });
  }

  async function addFiles(files){
    const arr=Array.from(files).filter(f=>f.type&&f.type.startsWith('image/'));
    if(!arr.length) return;
    const loaded=await Promise.all(arr.map(loadFile));
    items.push(...loaded);
    updateUI();
  }

  window.addEventListener('paste',async(e)=>{
    const dt=e.clipboardData; if(!dt) return;
    const files=[];
    for(const item of dt.items){
      if(item.kind==='file'){
        const f=item.getAsFile();
        if(f&&f.type&&f.type.startsWith('image/')) files.push(f);
      }
    }
    if(files.length){ e.preventDefault(); await addFiles(files); }
  });

  drop.addEventListener('dragover',(e)=>{e.preventDefault();drop.classList.add('dragover');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('dragover'));
  drop.addEventListener('drop',async(e)=>{
    e.preventDefault(); drop.classList.remove('dragover');
    if(e.dataTransfer?.files?.length) await addFiles(e.dataTransfer.files);
  });

  addBtn.onclick=()=>fileInput.click();
  fileInput.onchange=()=>{ addFiles(fileInput.files); fileInput.value=''; };
  clearBtn.onclick=clearAll;

  function renderPreviewFromExport(outW, outH){
    const retina = !!retinaEl.checked;
    const dpr = retina ? (window.devicePixelRatio || 1) : 1;

    canvas.style.width = outW + 'px';
    canvas.style.height = outH + 'px';

    canvas.width = Math.max(1, Math.floor(outW * dpr));
    canvas.height = Math.max(1, Math.floor(outH * dpr));

    pctx.setTransform(1,0,0,1,0,0);
    pctx.clearRect(0,0,canvas.width,canvas.height);

    pctx.imageSmoothingEnabled = true;
    pctx.imageSmoothingQuality = 'high';
    pctx.setTransform(dpr,0,0,dpr,0,0);
    pctx.drawImage(exportCanvas, 0, 0);
    pctx.setTransform(1,0,0,1,0,0);
  }

  // --- AUTO TRIM (align content) ---
  // Trims borders that match "bgColor" (or top-left pixel if bgColor invalid), with tolerance.
  function trimToContent(imgCanvas, bgColor, tol){
    const w = imgCanvas.width, h = imgCanvas.height;
    const tctx = imgCanvas.getContext('2d');
    const data = tctx.getImageData(0,0,w,h).data;

    // Use top-left pixel as fallback background sample (works for screenshots with white/solid margins)
    const tl = [data[0], data[1], data[2], data[3]];

    function hexToRGBA(hex){
      const m = (hex||'').trim().match(/^#?([0-9a-f]{6})$/i);
      if(!m) return null;
      const v = m[1];
      return [parseInt(v.slice(0,2),16), parseInt(v.slice(2,4),16), parseInt(v.slice(4,6),16), 255];
    }
    const bg = hexToRGBA(bgColor) || tl;

    const step = Math.max(1, Math.floor(Math.min(w,h)/600)); // speed on large images
    const tol2 = Math.max(0, Math.min(40, tol|0));

    function isBg(i){
      const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
      // treat near-transparent as background
      if(a < 16) return true;
      return (Math.abs(r-bg[0])<=tol2 && Math.abs(g-bg[1])<=tol2 && Math.abs(b-bg[2])<=tol2);
    }

    let top=0, left=0, right=w-1, bottom=h-1;

    // top
    topScan:
    for(let y=0;y<h;y+=step){
      for(let x=0;x<w;x+=step){
        const i=(y*w+x)*4;
        if(!isBg(i)){ top=y; break topScan; }
      }
    }
    // bottom
    bottomScan:
    for(let y=h-1;y>=0;y-=step){
      for(let x=0;x<w;x+=step){
        const i=(y*w+x)*4;
        if(!isBg(i)){ bottom=y; break bottomScan; }
      }
    }
    // left
    leftScan:
    for(let x=0;x<w;x+=step){
      for(let y=top;y<=bottom;y+=step){
        const i=(y*w+x)*4;
        if(!isBg(i)){ left=x; break leftScan; }
      }
    }
    // right
    rightScan:
    for(let x=w-1;x>=0;x-=step){
      for(let y=top;y<=bottom;y+=step){
        const i=(y*w+x)*4;
        if(!isBg(i)){ right=x; break rightScan; }
      }
    }

    // If nothing found, return original
    if(right<=left || bottom<=top){
      return {canvas: imgCanvas, w, h};
    }

    // Expand bounds slightly to avoid cutting 1px lines
    left = Math.max(0, left-2);
    top = Math.max(0, top-2);
    right = Math.min(w-1, right+2);
    bottom = Math.min(h-1, bottom+2);

    const cw = right-left+1;
    const ch = bottom-top+1;

    const out = document.createElement('canvas');
    out.width = cw;
    out.height = ch;
    out.getContext('2d').drawImage(imgCanvas, left, top, cw, ch, 0, 0, cw, ch);
    return {canvas: out, w: cw, h: ch};
  }

  function imageToCanvas(img, w, h){
    const c=document.createElement('canvas');
    c.width=w; c.height=h;
    c.getContext('2d').drawImage(img,0,0);
    return c;
  }

  mergeBtn.onclick=async()=>{
    warnEl.textContent='';

    const gap=Math.max(0,parseInt(gapEl.value||'0',10));
    const bgInput=(bgEl.value||'#ffffff').trim();
    const bg = safeParseColor(bgInput);
    const cap4k=!!cap4kEl.checked;
    const crisp=!!crispTextEl.checked;
    const autoTrim=!!autoTrimEl.checked;
    const tol=Math.max(0,Math.min(40,parseInt(trimTolEl.value||'12',10)));
    const align=alignEl.value;

    // global downscale to 4K cap (downscale only)
    const widestOrig=Math.max(...items.map(i=>i.w));
    const globalDown = (cap4k && widestOrig > MAX_4K) ? (MAX_4K / widestOrig) : 1; // <=1

    // Prepare per-image canvases (optionally trimmed)
    const prepared = items.map(it=>{
      const dw = Math.round(it.w * globalDown);
      const dh = Math.round(it.h * globalDown);

      // draw scaled into a canvas
      const base = document.createElement('canvas');
      base.width = dw; base.height = dh;
      const bctx = base.getContext('2d');

      const scalingHappens = (globalDown !== 1);
      bctx.imageSmoothingEnabled = crisp ? scalingHappens : true;
      bctx.imageSmoothingQuality = 'high';
      bctx.drawImage(it.img, 0, 0, dw, dh);

      if(!autoTrim){
        return {canvas: base, w: dw, h: dh};
      }
      return trimToContent(base, bgInput, tol);
    });

    const outW = Math.max(...prepared.map(p=>p.w));
    const outH = prepared.reduce((sum,p)=>sum+p.h,0) + gap*(prepared.length-1);

    // safety downscale if too huge
    let safety=1;
    const mp=(outW*outH)/1_000_000;
    if(mp>SAFE_MP) safety=Math.sqrt(SAFE_MP/mp);

    const finalW = Math.max(1, Math.floor(outW*safety));
    const finalH = Math.max(1, Math.floor(outH*safety));

    exportCanvas.width = finalW;
    exportCanvas.height = finalH;

    ectx.setTransform(1,0,0,1,0,0);
    ectx.fillStyle = bg;
    ectx.fillRect(0,0,exportCanvas.width,exportCanvas.height);

    const scalingHappens = (globalDown !== 1) || (safety !== 1);
    ectx.imageSmoothingEnabled = crisp ? scalingHappens : true;
    ectx.imageSmoothingQuality = 'high';
    ectx.scale(safety, safety);

    let y=0;
    for(const p of prepared){
      let x=0;
      if(align==='center') x = Math.floor((outW - p.w)/2);
      if(align==='right') x = Math.floor(outW - p.w);
      ectx.drawImage(p.canvas, x, Math.round(y));
      y += p.h + gap;
    }
    ectx.setTransform(1,0,0,1,0,0);

    // retina preview
    renderPreviewFromExport(finalW, finalH);

    // export blob
    if(lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
    const blob = await new Promise(res=>exportCanvas.toBlob(res,'image/png'));
    if(!blob){ warnEl.textContent='Export failed. Try fewer images.'; return; }
    lastBlobUrl = URL.createObjectURL(blob);

    openBtn.disabled=false;
    if(!navigator.clipboard || !window.ClipboardItem){
      copyBtn.disabled=true; copyBtn.textContent='Copy not supported';
    }else{
      copyBtn.disabled=false; copyBtn.textContent='Copy';
    }

    const mpFinal=(finalW*finalH)/1_000_000;
    statusEl.textContent=`Merged: ${finalW} × ${finalH}px (${mpFinal.toFixed(1)} MP)`;
    const msgs=[];
    if(autoTrim) msgs.push('Auto-trim enabled (content aligned).');
    if(globalDown!==1) msgs.push('Downscaled to 4K cap.');
    if(safety!==1) msgs.push('Safety downscale applied.');
    warnEl.textContent=msgs.join(' ');
  };

  copyBtn.onclick=async()=>{
    try{
      if(!navigator.clipboard || !window.ClipboardItem) return;
      const blob=await new Promise(res=>exportCanvas.toBlob(res,'image/png'));
      await navigator.clipboard.write([new ClipboardItem({'image/png':blob})]);
      warnEl.textContent='Copied ✅';
      setTimeout(()=>warnEl.textContent='',1500);
    }catch{
      warnEl.textContent='Copy failed. Use Open then copy from new tab.';
    }
  };

  openBtn.onclick=()=>{ if(lastBlobUrl) window.open(lastBlobUrl,'_blank','noopener,noreferrer'); };

  updateUI();
</script>
</body>
</html>